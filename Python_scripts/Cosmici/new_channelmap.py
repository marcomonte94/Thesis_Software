import numpy as np

'''
Key code: id_board * 100 + channel
'''

def channelMap(a):

    dt3 = np.dtype([
        ('id_bar',          np.int),
        ('layer',           np.int),
        ('side',            np.int),
        ('id_event',        np.int),
        ('ampl',            np.float,  (1024,)),
        ('time',            np.float,  (1024,))
        ])

    keys = list(zip(a['id_board'],a['channel']))

    dizionario_barre = {
        158*100+0: 0,
        158*100+1: 0,
        158*100+2: 1,
        158*100+3: 1,
        158*100+4: 2,
        158*100+5: 2,
        158*100+6: 3,
        158*100+7: 3,
        158*100+8: 4,
        158*100+9: 4,
        158*100+10: 5,
        158*100+11: 5,
        158*100+12: 6,
        158*100+13: 6,
        158*100+14: 7,
        158*100+15: 7,

        159*100+0: 8,
        159*100+1: 8,
        159*100+2: 10,
        159*100+3: 10,
        159*100+4: 11,
        159*100+5: 11,
        159*100+6: 12,
        159*100+7: 12,
        159*100+8: 13,
        159*100+9: 13,
        159*100+10: 14,
        159*100+11: 14,
        159*100+12: 15,
        159*100+13: 15,
        159*100+14: 16,
        159*100+15: 15,

        160*100+0: 17,
        160*100+1: 17,
        160*100+2: 18,
        160*100+3: 18,
        160*100+4: 19,
        160*100+5: 19,
        160*100+6: 0,
        160*100+7: 0,
        160*100+8: 1,
        160*100+9: 1,
        160*100+10: 2,
        160*100+11: 2,
        160*100+12: 3,
        160*100+13: 3,
        160*100+14: 4,
        160*100+15: 4,

        161*100+0: 8,
        161*100+1: 8,
        161*100+2: 10,
        161*100+3: 10,
        161*100+4: 11,
        161*100+5: 11,
        161*100+6: 12,
        161*100+7: 12,
        161*100+8: 13,
        161*100+10: 5,
        161*100+11: 5,
        161*100+12: 6,
        161*100+13: 6,
        161*100+14: 7,
        161*100+15: 7,

        164*100+0: 14,
        164*100+1: 14,
        164*100+2: 15,
        164*100+3: 15,
        164*100+4: 16,
        164*100+5: 16,
        164*100+6: 17,
        164*100+7: 17,
        164*100+8: 18,
        164*100+9: 18,
        164*100+10: 19,
        164*100+11: 19,

        163*100+0: 9,
        163*100+1: 9,
        163*100+2: 9,
        163*100+3: 9


    }

    dizionario_layer = {
        158*100+0: 1,
        158*100+1: 1,
        158*100+2: 1,
        158*100+3: 1,
        158*100+4: 1,
        158*100+5: 1,
        158*100+6: 1,
        158*100+7: 1,
        158*100+8: 1,
        158*100+9: 1,
        158*100+10: 1,
        158*100+11: 1,
        158*100+12: 1,
        158*100+13: 1,
        158*100+14: 1,
        158*100+15: 1,

        159*100+0: 1,
        159*100+1: 1,
        159*100+2: 1,
        159*100+3: 1,
        159*100+4: 1,
        159*100+5: 1,
        159*100+6: 1,
        159*100+7: 1,
        159*100+8: 1,
        159*100+9: 1,
        159*100+10: 1,
        159*100+11: 1,
        159*100+12: 1,
        159*100+13: 1,
        159*100+14: 1,
        159*100+15: 1,

        160*100+0: 1,
        160*100+1: 1,
        160*100+2: 1,
        160*100+3: 1,
        160*100+4: 1,
        160*100+5: 1,
        160*100+6: 0,
        160*100+7: 0,
        160*100+8: 0,
        160*100+9: 0,
        160*100+10: 0,
        160*100+11: 0,
        160*100+12: 0,
        160*100+13: 0,
        160*100+14: 0,
        160*100+15: 0,

        161*100+0: 0,
        161*100+1: 0,
        161*100+2: 0,
        161*100+3: 0,
        161*100+4: 0,
        161*100+5: 0,
        161*100+6: 0,
        161*100+7: 0,
        161*100+8: 0,
        161*100+10: 0,
        161*100+11: 0,
        161*100+12: 0,
        161*100+13: 0,
        161*100+14: 0,
        161*100+15: 0,

        164*100+0: 0,
        164*100+1: 0,
        164*100+2: 0,
        164*100+3: 0,
        164*100+4: 0,
        164*100+5: 0,
        164*100+6: 0,
        164*100+7: 0,
        164*100+8: 0,
        164*100+9: 0,
        164*100+10: 0,
        164*100+11: 0,

        163*100+0: 1,
        163*100+1: 1,
        163*100+2: 0,
        163*100+3: 0


    }

    #a_selected = a[a['id_board']<=159]

    keys = a['id_board']*100 + a['channel']
    mapped_events = np.zeros(len(a),dtype=dt3)

    import pandas as pd

    xx = pd.Series(keys).replace(dizionario_barre)
    mapped_events['id_bar'] = xx
    #print(xx)

    xx = pd.Series(keys).replace(dizionario_layer)
    mapped_events['layer'] = xx
    #print(mapped_events['layer'])


    mapped_events['time'] = a['time']
    mapped_events['ampl'] = a['ampl']
    mapped_events['id_event'] = a['id_event']
    mapped_events['side'] = a['channel']%2

    return mapped_events


dt = np.dtype([
    ('channel',         np.int),
    ('id_board',        np.int),
    ('id_event',        np.int),
    ('always_0_1',      np.int),
    ('always_0_2',      np.int),
    ('ampl',            np.float, (1024, )),
    ('time',            np.float, (1024, ))
  ])

if __name__ == '__main__':
    path = 'C:/Users/Marco/Desktop/cosmic/prova.dec'
    a = np.fromfile(path, dtype=dt)
    e = channelMap(a)
    print(e[0]['id_bar'])
